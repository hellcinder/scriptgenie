<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Genie - Professional Screenplay Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0d6efd;
            --accent-hover: #0b5ed7;
            --success-color: #198754;
            --warning-color: #fd7e14;
            --danger-color: #dc3545;
            --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: #404040;
            --accent-color: #4dabf7;
            --accent-hover: #339af0;
            --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier Prime', 'Courier New', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            transform: rotate(180deg);
        }

        .main-content {
            flex: 1;
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            gap: 1rem;
            padding: 1rem;
        }

        .sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .sidebar-section h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .title-inputs {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-field {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .action-btn {
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        .action-btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }

        .presets-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
        }

        .preset-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preset-item:hover {
            background: var(--bg-tertiary);
        }

        .preset-item:last-child {
            border-bottom: none;
        }

        .preset-delete {
            color: var(--danger-color);
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .preset-delete:hover {
            opacity: 1;
        }

        .editor-container {
            flex: 1;
            display: flex;
            gap: 1rem;
        }

        .editor-pane,
        .preview-pane {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .pane-header {
            background: var(--bg-tertiary);
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--border-color);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85rem;
        }

        .editor-textarea {
            flex: 1;
            border: none;
            resize: none;
            padding: 2rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Courier Prime', 'Courier New', monospace;
            font-size: 12pt;
            line-height: 1.5;
            tab-size: 4;
            transition: all 0.2s ease;
        }

        .editor-textarea:focus {
            outline: none;
            background: var(--bg-primary);
        }

        .preview-content {
            flex: 1;
            padding: 1rem;
            background: white;
            color: #000;
            font-family: 'Courier Prime', 'Courier New', monospace;
            font-size: 12pt;
            line-height: 1.5;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .script-content {
            width: 100%;
            max-width: 8.5in;
            padding: 1rem;
        }

        .timer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .timer-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .timer-display {
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-color);
            margin: 1rem 0;
            font-family: 'Courier Prime', monospace;
        }

        .timer-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .autocomplete-popup {
            position: absolute;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            box-shadow: var(--shadow-lg);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: var(--accent-color);
            color: white;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        /* Screenplay formatting */
        .scene-heading {
            font-weight: bold;
            text-transform: uppercase;
            margin: 1.5rem 0 1rem 0;
            page-break-after: avoid;
            font-size: 12pt;
        }

        .character-name {
            font-weight: bold;
            text-transform: uppercase;
            margin: 1.5rem 0 0.25rem 0;
            text-align: center;
            page-break-after: avoid;
            font-size: 12pt;
        }

        .dialogue {
            margin: 0.25rem auto 1rem auto;
            max-width: 35em;
            text-align: left;
            padding: 0 1rem;
            font-size: 12pt;
            line-height: 1.5;
        }

        .parenthetical {
            margin: 0.25rem auto;
            max-width: 30em;
            text-align: center;
            font-style: italic;
            font-size: 12pt;
        }

        .transition {
            font-weight: bold;
            text-transform: uppercase;
            text-align: right;
            margin: 1.5rem 0 1.5rem 0;
            page-break-before: avoid;
            font-size: 12pt;
        }

        .action {
            margin: 1rem 0;
            text-align: left;
            font-size: 12pt;
            line-height: 1.5;
        }

        .empty-line {
            height: 1.5rem;
            font-size: 12pt;
        }

        .title-page {
            text-align: center;
            margin-top: 3.5in;
            margin-bottom: 1in;
            position: relative;
            width: 100%;
        }

        .title-page .title {
            font-weight: bold;
            font-size: 14pt;
            text-transform: uppercase;
            margin-bottom: 2rem;
        }

        .title-page .author-info {
            position: absolute;
            bottom: -2in;
            right: 0;
            text-align: left;
            font-size: 12pt;
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: -1;
            }
            
            .editor-container {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .header-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">üé¨</div>
                    <h1>Script Genie</h1>
                    <h4>     by John Donham</h4>
                </div>
                <div class="header-controls">
                    <button class="btn" onclick="exportToPDF()">üìÑ Export PDF</button>
                    <button class="btn btn-primary" onclick="showTimer()">‚è±Ô∏è Writing Sprint</button>
                    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3>Title Page</h3>
                    <div class="title-inputs">
                        <div class="input-group">
                            <label for="scriptTitle">Script Title</label>
                            <input type="text" id="scriptTitle" class="input-field" placeholder="Enter script title">
                        </div>
                        <div class="input-group">
                            <label for="authorName">Author Name</label>
                            <input type="text" id="authorName" class="input-field" placeholder="Your name">
                        </div>
                        <div class="input-group">
                            <label for="contactInfo">Contact Info</label>
                            <textarea id="contactInfo" class="input-field" rows="3" placeholder="Email, phone, address"></textarea>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Quick Insert</h3>
                    <div class="quick-actions">
                        <button class="action-btn" onclick="insertElement('character')">Character</button>
                        <button class="action-btn" onclick="insertElement('scene')">Scene</button>
                        <button class="action-btn" onclick="insertElement('transition')">Transition</button>
                        <button class="action-btn" onclick="insertElement('parenthetical')">Parenthetical</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Presets</h3>
                    <div class="input-group">
                        <input type="text" id="newPreset" class="input-field" placeholder="Add location/character">
                        <button class="btn" onclick="addPreset()">Add Preset</button>
                    </div>
                    <div class="presets-list" id="presetsList">
                        <div class="preset-item" onclick="insertPreset('INT. HOUSE - DAY')">
                            INT. HOUSE - DAY
                            <span class="preset-delete" onclick="event.stopPropagation(); deletePreset('INT. HOUSE - DAY')">√ó</span>
                        </div>
                        <div class="preset-item" onclick="insertPreset('EXT. STREET - NIGHT')">
                            EXT. STREET - NIGHT
                            <span class="preset-delete" onclick="event.stopPropagation(); deletePreset('EXT. STREET - NIGHT')">√ó</span>
                        </div>
                        <div class="preset-item" onclick="insertPreset('JOHN')">
                            JOHN
                            <span class="preset-delete" onclick="event.stopPropagation(); deletePreset('JOHN')">√ó</span>
                        </div>
                    </div>
                </div>
            </aside>

            <div class="editor-container">
                <div class="editor-pane">
                    <div class="pane-header">üìù Fountain Editor</div>
                    <textarea 
                        id="scriptEditor" 
                        class="editor-textarea"
                        placeholder="Start writing your screenplay here using Fountain format...

Example:
FADE IN:

EXT. HOUSE - DAY

A quiet suburban street. Birds chirping.

JOHN (30s) walks up to the front door.

JOHN
(knocking)
Hello? Anyone home?

MARY (O.S.)
Just a minute!

CUT TO:"
                        oninput="updatePreview()"
                        onkeydown="handleKeyDown(event)"
                        onkeyup="handleAutoComplete(event)"
                    ></textarea>
                    <div class="autocomplete-popup" id="autocompletePopup"></div>
                </div>

                <div class="preview-pane">
                    <div class="pane-header">üëÅÔ∏è Live Preview</div>
                    <div class="preview-content" id="scriptPreview">
                        <div class="title-page">
                            <div class="title" id="previewTitle">YOUR SCRIPT TITLE</div>
                            <div class="author-info" id="previewAuthor">
                                <div>Written by</div>
                                <div>Your Name</div>
                                <div>Contact Info</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Timer Modal -->
    <div class="timer-modal" id="timerModal">
        <div class="timer-content">
            <h2>Writing Sprint Timer</h2>
            <div class="input-group">
                <label>Minutes</label>
                <input type="number" id="timerMinutes" class="input-field" value="25" min="1" max="120">
            </div>
            <div class="timer-display" id="timerDisplay">25:00</div>
            <div class="timer-controls">
                <button class="btn btn-primary" id="startTimer" onclick="startTimer()">Start</button>
                <button class="btn" id="pauseTimer" onclick="pauseTimer()" style="display: none;">Pause</button>
                <button class="btn" onclick="resetTimer()">Reset</button>
                <button class="btn" onclick="closeTimer()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentTheme = 'light';
        let presets = ['INT. HOUSE - DAY', 'EXT. STREET - NIGHT', 'JOHN', 'MARY', 'FADE IN:', 'FADE OUT:', 'CUT TO:'];
        let characters = new Set();
        let locations = new Set();
        let timerInterval = null;
        let timerSeconds = 0;
        let timerRunning = false;

        // Theme management
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', currentTheme);
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            }
            
            // Save theme preference
            localStorage.setItem('scriptGenie_theme', currentTheme);
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('scriptGenie_theme');
            if (savedTheme) {
                currentTheme = savedTheme;
                document.body.setAttribute('data-theme', currentTheme);
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                }
            }
        }

        // Fountain parser
        function parseFountain(text) {
            const lines = text.split('\n');
            const parsed = [];
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                let type = 'action';
                let content = line;
                
                // Skip empty lines but track them
                if (line.trim() === '') {
                    parsed.push({ type: 'empty', content: '' });
                    continue;
                }
                
                // Scene headings - must start with specific keywords
                if (/^(INT\.|EXT\.|INT\.\/EXT\.|FADE IN:|FADE OUT:)/i.test(line.trim())) {
                    type = 'scene-heading';
                    
                    // Extract location for autocomplete
                    const locationMatch = line.match(/(INT\.|EXT\.|INT\.\/EXT\.)\s+([^-]+)/i);
                    if (locationMatch) {
                        locations.add(locationMatch[2].trim());
                    }
                }
                // Transitions - all caps ending with ':'
                else if (/^[A-Z][A-Z\s]*:$/.test(line.trim()) || 
                         /^(CUT TO:|DISSOLVE TO:|FADE TO:|MATCH CUT:|JUMP CUT:|SMASH CUT:)/i.test(line.trim())) {
                    type = 'transition';
                }
                // Character names - all caps, no punctuation except parentheses, not too long
                else if (/^[A-Z][A-Z\s]*(\([^)]*\))?$/.test(line.trim()) && 
                         line.trim().length > 1 && 
                         line.trim().length < 50 &&
                         !line.includes('.') &&
                         !line.includes(':') &&
                         i < lines.length - 1 && 
                         lines[i + 1].trim() !== '') {
                    
                    // Check if next non-empty line looks like dialogue (not all caps)
                    let nextLineIndex = i + 1;
                    while (nextLineIndex < lines.length && lines[nextLineIndex].trim() === '') {
                        nextLineIndex++;
                    }
                    
                    if (nextLineIndex < lines.length) {
                        const nextLine = lines[nextLineIndex].trim();
                        // If next line is not all caps or starts with '(', it's likely dialogue
                        if (!(/^[A-Z][A-Z\s]*:?$/.test(nextLine)) || nextLine.startsWith('(')) {
                            type = 'character';
                            characters.add(line.trim().replace(/\([^)]*\)/, '').trim());
                        }
                    }
                }
                // Parentheticals - wrapped in parentheses
                else if (/^\s*\([^)]+\)\s*$/.test(line.trim())) {
                    type = 'parenthetical';
                }
                // Dialogue - follows character name or parenthetical
                else if (i > 0) {
                    // Look backwards to find the most recent non-empty line
                    let prevIndex = i - 1;
                    while (prevIndex >= 0 && parsed[prevIndex] && parsed[prevIndex].type === 'empty') {
                        prevIndex--;
                    }
                    
                    if (prevIndex >= 0 && parsed[prevIndex] && 
                        (parsed[prevIndex].type === 'character' || parsed[prevIndex].type === 'parenthetical')) {
                        type = 'dialogue';
                    }
                    // Continue dialogue if previous line was dialogue and this line is not all caps
                    else if (prevIndex >= 0 && parsed[prevIndex] && 
                             parsed[prevIndex].type === 'dialogue' && 
                             !(/^[A-Z][A-Z\s]*:?$/.test(line.trim()))) {
                        type = 'dialogue';
                    }
                }
                
                parsed.push({ type, content: line });
            }
            
            return parsed;
        }

        // Format parsed script for preview
        function formatScript(parsed) {
            return parsed.map(element => {
                const { type, content } = element;
                
                switch (type) {
                    case 'empty':
                        return '<div class="empty-line">&nbsp;</div>';
                    case 'scene-heading':
                        return `<div class="scene-heading">${escapeHtml(content)}</div>`;
                    case 'character':
                        return `<div class="character-name">${escapeHtml(content)}</div>`;
                    case 'dialogue':
                        return `<div class="dialogue">${escapeHtml(content)}</div>`;
                    case 'parenthetical':
                        return `<div class="parenthetical">${escapeHtml(content)}</div>`;
                    case 'transition':
                        return `<div class="transition">${escapeHtml(content)}</div>`;
                    case 'action':
                    default:
                        return `<div class="action">${escapeHtml(content)}</div>`;
                }
            }).join('');
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update preview
        function updatePreview() {
            const editor = document.getElementById('scriptEditor');
            const preview = document.getElementById('scriptPreview');
            const title = document.getElementById('scriptTitle');
            const author = document.getElementById('authorName');
            const contact = document.getElementById('contactInfo');
            
            // Check if all elements exist before proceeding
            if (!editor || !preview || !title || !author || !contact) {
                return;
            }
            
            // Update title page
            const previewTitle = document.getElementById('previewTitle');
            const previewAuthor = document.getElementById('previewAuthor');
            
            if (previewTitle) {
                previewTitle.textContent = title.value || 'YOUR SCRIPT TITLE';
            }
            
            let authorInfo = 'Written by<br>';
            authorInfo += (author.value || 'Your Name') + '<br>';
            if (contact.value) {
                authorInfo += contact.value.replace(/\n/g, '<br>');
            }
            
            if (previewAuthor) {
                previewAuthor.innerHTML = authorInfo;
            }
            
            // Parse and format script
            if (editor.value && editor.value.trim()) {
                const parsed = parseFountain(editor.value);
                const formatted = formatScript(parsed);
                
                // Add title page + script content
                const titlePageHtml = `
                    <div class="script-content">
                        <div class="title-page">
                            <div class="title">${title.value || 'YOUR SCRIPT TITLE'}</div>
                            <div class="author-info">
                                ${authorInfo}
                            </div>
                        </div>
                        <div style="page-break-before: always; padding-top: 1in;">
                            ${formatted}
                        </div>
                    </div>
                `;
                
                if (preview) {
                    preview.innerHTML = titlePageHtml;
                }
            } else {
                const defaultHtml = `
                    <div class="script-content">
                        <div class="title-page">
                            <div class="title">${title.value || 'YOUR SCRIPT TITLE'}</div>
                            <div class="author-info">
                                ${authorInfo}
                            </div>
                        </div>
                    </div>
                `;
                
                if (preview) {
                    preview.innerHTML = defaultHtml;
                }
            }
        }

        // Auto-completion
        function handleAutoComplete(event) {
            const editor = document.getElementById('scriptEditor');
            const popup = document.getElementById('autocompletePopup');
            const cursorPos = editor.selectionStart;
            const text = editor.value;
            
            // Get current line
            const lineStart = text.lastIndexOf('\n', cursorPos - 1) + 1;
            const lineEnd = text.indexOf('\n', cursorPos);
            const currentLine = text.substring(lineStart, lineEnd === -1 ? text.length : lineEnd);
            
            // Check if we should show autocomplete
            if (currentLine.length > 0 && !event.ctrlKey && !event.altKey && !event.metaKey) {
                const suggestions = [...characters, ...locations, ...presets].filter(item =>
                    item.toLowerCase().includes(currentLine.toLowerCase())
                );
                
                if (suggestions.length > 0 && currentLine.trim() !== '') {
                    showAutoComplete(suggestions, editor, lineStart);
                } else {
                    hideAutoComplete();
                }
            } else {
                hideAutoComplete();
            }
        }

        function showAutoComplete(suggestions, editor, lineStart) {
            const popup = document.getElementById('autocompletePopup');
            popup.innerHTML = suggestions.map(suggestion => 
                `<div class="autocomplete-item" onclick="insertSuggestion('${suggestion}', ${lineStart})">${suggestion}</div>`
            ).join('');
            
            // Position popup
            const rect = editor.getBoundingClientRect();
            popup.style.left = rect.left + 'px';
            popup.style.top = (rect.top + 100) + 'px';
            popup.style.display = 'block';
        }

        function hideAutoComplete() {
            document.getElementById('autocompletePopup').style.display = 'none';
        }

        function insertSuggestion(suggestion, lineStart) {
            const editor = document.getElementById('scriptEditor');
            const text = editor.value;
            const cursorPos = editor.selectionStart;
            const lineEnd = text.indexOf('\n', cursorPos);
            
            const newText = text.substring(0, lineStart) + suggestion + text.substring(lineEnd === -1 ? text.length : lineEnd);
            editor.value = newText;
            editor.selectionStart = editor.selectionEnd = lineStart + suggestion.length;
            
            hideAutoComplete();
            updatePreview();
            editor.focus();
        }

        // Key handling
        function handleKeyDown(event) {
            const editor = document.getElementById('scriptEditor');
            
            // Hide autocomplete on escape
            if (event.key === 'Escape') {
                hideAutoComplete();
                return;
            }
            
            // Handle tab for proper screenplay formatting
            if (event.key === 'Tab') {
                event.preventDefault();
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                
                // Insert 4 spaces instead of tab
                editor.value = editor.value.substring(0, start) + '    ' + editor.value.substring(end);
                editor.selectionStart = editor.selectionEnd = start + 4;
                updatePreview();
            }
        }

        // Quick insert functions
        function insertElement(type) {
            const editor = document.getElementById('scriptEditor');
            const cursorPos = editor.selectionStart;
            let insertText = '';
            let cursorOffset = 0; // How many characters back from the end to place cursor
            
            switch (type) {
                case 'character':
                    insertText = '\n\nCHARACTER NAME\nDialogue goes here.\n';
                    cursorOffset = insertText.length - 'CHARACTER NAME\nDialogue goes here.\n'.length;
                    break;
                case 'scene':
                    insertText = '\n\nINT. LOCATION - DAY\n\nAction description here.\n';
                    cursorOffset = insertText.length - 'INT. LOCATION - DAY\n\nAction description here.\n'.length;
                    break;
                case 'transition':
                    insertText = '\n\nCUT TO:\n';
                    cursorOffset = insertText.length - 'CUT TO:\n'.length;
                    break;
                case 'parenthetical':
                    insertText = '\n(beat)\n';
                    cursorOffset = insertText.length - '(beat)\n'.length;
                    break;
            }
            
            const newText = editor.value.substring(0, cursorPos) + insertText + editor.value.substring(cursorPos);
            editor.value = newText;
            
            // Position cursor at the start of the placeholder text
            editor.selectionStart = editor.selectionEnd = cursorPos + cursorOffset;
            editor.focus();
            updatePreview();
        }

        // Preset management
        function addPreset() {
            const input = document.getElementById('newPreset');
            const preset = input.value.trim().toUpperCase();
            
            if (preset && !presets.includes(preset)) {
                presets.push(preset);
                updatePresetsList();
                input.value = '';
                
                // Save to localStorage
                localStorage.setItem('scriptGenie_presets', JSON.stringify(presets));
            }
        }

        function deletePreset(preset) {
            presets = presets.filter(p => p !== preset);
            updatePresetsList();
            localStorage.setItem('scriptGenie_presets', JSON.stringify(presets));
        }

        function insertPreset(preset) {
            const editor = document.getElementById('scriptEditor');
            const cursorPos = editor.selectionStart;
            
            const newText = editor.value.substring(0, cursorPos) + preset + editor.value.substring(cursorPos);
            editor.value = newText;
            editor.selectionStart = editor.selectionEnd = cursorPos + preset.length;
            editor.focus();
            updatePreview();
        }

        function updatePresetsList() {
            const list = document.getElementById('presetsList');
            list.innerHTML = presets.map(preset => `
                <div class="preset-item" onclick="insertPreset('${preset}')">
                    ${preset}
                    <span class="preset-delete" onclick="event.stopPropagation(); deletePreset('${preset}')">√ó</span>
                </div>
            `).join('');
        }

        // Load presets from localStorage
        function loadPresets() {
            const saved = localStorage.getItem('scriptGenie_presets');
            if (saved) {
                presets = JSON.parse(saved);
                updatePresetsList();
            }
        }

        // Timer functions
        function showTimer() {
            document.getElementById('timerModal').style.display = 'flex';
            resetTimer();
        }

        function closeTimer() {
            document.getElementById('timerModal').style.display = 'none';
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerRunning = false;
        }

        function startTimer() {
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 25;
            timerSeconds = minutes * 60;
            timerRunning = true;
            
            document.getElementById('startTimer').style.display = 'none';
            document.getElementById('pauseTimer').style.display = 'inline-block';
            
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                
                if (timerSeconds <= 0) {
                    timerComplete();
                }
            }, 1000);
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerRunning = false;
            
            document.getElementById('startTimer').style.display = 'inline-block';
            document.getElementById('pauseTimer').style.display = 'none';
            document.getElementById('startTimer').textContent = 'Resume';
        }

        function resetTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerRunning = false;
            
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 25;
            timerSeconds = minutes * 60;
            updateTimerDisplay();
            
            document.getElementById('startTimer').style.display = 'inline-block';
            document.getElementById('pauseTimer').style.display = 'none';
            document.getElementById('startTimer').textContent = 'Start';
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
        }

        function timerComplete() {
            clearInterval(timerInterval);
            timerInterval = null;
            timerRunning = false;
            
            // Play alarm sound (using Web Audio API for retro beep)
            playAlarmSound();
            
            // Show completion message
            document.getElementById('timerDisplay').textContent = 'TIME\'S UP!';
            document.getElementById('timerDisplay').style.color = 'var(--danger-color)';
            
            // Reset button states
            document.getElementById('startTimer').style.display = 'inline-block';
            document.getElementById('pauseTimer').style.display = 'none';
            document.getElementById('startTimer').textContent = 'Start';
            
            // Auto-reset after 3 seconds
            setTimeout(() => {
                document.getElementById('timerDisplay').style.color = 'var(--accent-color)';
                resetTimer();
            }, 3000);
        }

        function playAlarmSound() {
            try {
                // Create a simple beep using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 1);
                
                // Play multiple beeps
                setTimeout(() => {
                    const oscillator2 = audioContext.createOscillator();
                    const gainNode2 = audioContext.createGain();
                    
                    oscillator2.connect(gainNode2);
                    gainNode2.connect(audioContext.destination);
                    
                    oscillator2.frequency.setValueAtTime(1000, audioContext.currentTime);
                    gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                    
                    oscillator2.start();
                    oscillator2.stop(audioContext.currentTime + 1);
                }, 200);
            } catch (error) {
                console.log('Audio not supported or blocked');
            }
        }

        // Export to PDF
        function exportToPDF() {
            // For web version, we'll use the browser's print functionality
            // Create a new window with print-optimized styling
            const printWindow = window.open('', '_blank');
            const title = document.getElementById('scriptTitle').value || 'Untitled Script';
            const author = document.getElementById('authorName').value || 'Unknown Author';
            const contact = document.getElementById('contactInfo').value || '';
            const content = document.getElementById('scriptPreview').innerHTML;
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
                        
                        body {
                            font-family: 'Courier Prime', 'Courier New', monospace;
                            font-size: 12pt;
                            line-height: 1.5;
                            margin: 0;
                            padding: 0;
                            background: white;
                            color: black;
                        }
                        
                        @page {
                            margin: 1in 1in 1in 1.5in;
                        }
                        
                        .title-page {
                            text-align: center;
                            margin-top: 3.5in;
                            page-break-after: always;
                        }
                        
                        .title {
                            font-weight: bold;
                            font-size: 14pt;
                            text-transform: uppercase;
                            margin-bottom: 2rem;
                        }
                        
                        .author-info {
                            position: fixed;
                            bottom: 1in;
                            right: 1in;
                            text-align: left;
                        }
                        
                        .scene-heading {
                            font-weight: bold;
                            text-transform: uppercase;
                            margin: 1rem 0 0.5rem 0;
                            page-break-after: avoid;
                        }
                        
                        .character-name {
                            font-weight: bold;
                            text-transform: uppercase;
                            margin: 1rem 0 0.25rem 3.7rem;
                            text-align: left;
                            page-break-after: avoid;
                        }
                        
                        .dialogue {
                            margin: 0 1rem 0.5rem 2.5rem;
                            max-width: 3.5in;
                            page-break-inside: avoid;
                        }
                        
                        .parenthetical {
                            margin: 0 1.5rem 0.25rem 3.1rem;
                            font-style: normal;
                        }
                        
                        .transition {
                            font-weight: bold;
                            text-transform: uppercase;
                            text-align: right;
                            margin: 1rem 0;
                            page-break-before: avoid;
                        }
                        
                        .action {
                            margin: 0.5rem 0;
                        }
                        
                        .empty-line {
                            height: 1.5em;
                        }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Wait for content to load, then print
            printWindow.onload = function() {
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };
        }

        // Auto-save functionality
        function saveScript() {
            const scriptData = {
                title: document.getElementById('scriptTitle').value,
                author: document.getElementById('authorName').value,
                contact: document.getElementById('contactInfo').value,
                content: document.getElementById('scriptEditor').value,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('scriptGenie_autosave', JSON.stringify(scriptData));
        }

        function loadScript() {
            const saved = localStorage.getItem('scriptGenie_autosave');
            if (saved) {
                const scriptData = JSON.parse(saved);
                const titleField = document.getElementById('scriptTitle');
                const authorField = document.getElementById('authorName');
                const contactField = document.getElementById('contactInfo');
                const editorField = document.getElementById('scriptEditor');
                
                if (titleField) titleField.value = scriptData.title || '';
                if (authorField) authorField.value = scriptData.author || '';
                if (contactField) contactField.value = scriptData.contact || '';
                if (editorField) editorField.value = scriptData.content || '';
                
                updatePreview();
            }
        }

        // Auto-save every 30 seconds
        setInterval(saveScript, 30000);

        // Update timer display when minutes change
        document.getElementById('timerMinutes').addEventListener('input', function() {
            if (!timerRunning) {
                resetTimer();
            }
        });

        // Add event listeners for title page updates
        document.getElementById('scriptTitle').addEventListener('input', updatePreview);
        document.getElementById('authorName').addEventListener('input', updatePreview);
        document.getElementById('contactInfo').addEventListener('input', updatePreview);

        // Add auto-save on input
        document.getElementById('scriptEditor').addEventListener('input', function() {
            updatePreview();
            // Debounced save after 2 seconds of no typing
            clearTimeout(window.autoSaveTimeout);
            window.autoSaveTimeout = setTimeout(saveScript, 2000);
        });

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            loadPresets();
            loadScript();
            updatePreview();
            
            // Focus on editor
            document.getElementById('scriptEditor').focus();
        });

        // Handle beforeunload to save work
        window.addEventListener('beforeunload', function(e) {
            saveScript();
        });

        // Click outside to hide autocomplete
        document.addEventListener('click', function(event) {
            if (!event.target.closest('#autocompletePopup') && !event.target.closest('#scriptEditor')) {
                hideAutoComplete();
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Ctrl/Cmd + S to save (just trigger autosave)
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                saveScript();
                
                // Show brief save confirmation
                const editor = document.querySelector('.editor-pane .pane-header');
                const originalText = editor.textContent;
                editor.textContent = 'üíæ Saved!';
                setTimeout(() => {
                    editor.textContent = originalText;
                }, 1000);
            }
            
            // Ctrl/Cmd + P to export PDF
            if ((event.ctrlKey || event.metaKey) && event.key === 'p') {
                event.preventDefault();
                exportToPDF();
            }
            
            // Ctrl/Cmd + T to toggle theme
            if ((event.ctrlKey || event.metaKey) && event.key === 't') {
                event.preventDefault();
                toggleTheme();
            }
        });
    </script>
</body>
</html>
